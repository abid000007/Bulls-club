name: CI/CD with Build Status to Pushgateway

on:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Simulate a build
        id: build-step
        run: |
          start_time=$(date +%s)
          echo "hi"
          exit 0
          end_time=$(date +%s)
          duration=$((end_time - start_time))
          echo "BUILD_DURATION=$duration" >> $GITHUB_OUTPUT

      - name: Push build status to Pushgateway
        if: always()
        run: |
          if [ "${{ job.status }}" = "success" ]; then
            STATUS="success"
          else
            STATUS="failure"
          fi
          echo -e "build_status{repository=\"${{ github.repository }}\",branch=\"${{ github.ref_name }}\",run_id=\"${{ github.run_id }}\",status=\"$STATUS\"} 1\nbuild_duration_seconds{repository=\"${{ github.repository }}\",branch=\"${{ github.ref_name }}\",run_id=\"${{ github.run_id }}\",status=\"$STATUS\"} ${{ steps.build-step.outputs['BUILD_DURATION'] }}" | \
          curl --data-binary @- http://a855f71a64930465fb5339ea184d1d3f-381870272.us-east-1.elb.amazonaws.com:9091/metrics/job/build_pipeline
